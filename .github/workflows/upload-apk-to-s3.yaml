name: "Upload APK file to S3 and Invalidate CloudFront"
description: "Uploads a file to AWS S3 and optionally invalidates CloudFront cache."

inputs:
  file:
    description: "Local path to the file to upload (e.g. download/app-release.apk)"
    required: true
  destination:
    description: "S3 destination path (e.g. s3://my-bucket/apk/app-release.apk)"
    required: true
  region:
    description: "AWS region (default: ap-northeast-2)"
    required: false
    default: "ap-northeast-2"
  role_arn:
    description: "IAM Role ARN to assume via OIDC"
    required: true
  aws_accountid:
    description: "aws account id"
    required: true
  cloudfront_distribution_id:
    description: "CloudFront Distribution ID to invalidate"
    required: false
  app_name:
    description: "guard or interphone"
    required: true
  version:
    description: "app version number"
    required: true


runs:
  using: "composite"
  steps:
    # Login To HVC_Admin_Automation for Deploy
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ inputs.role_arn }}
        role-session-name: githubactions
        aws-region: ${{ inputs.region }}

    # Assume to Each Account as AWSControlTowerExecution
    - name: Upload file to S3
      run: |
        # Assume Role using an Automation Key
        identity=$(aws sts assume-role --role-arn arn:aws:iam::${{ inputs.aws_accountid }}:role/AWSTerraformAssumeRole --role-session-name AWS)
        export AWS_ACCESS_KEY_ID=$(echo "$identity" | grep -o '"AccessKeyId": "[^"]*' | awk -F'"' '{print $4}')
        export AWS_SECRET_ACCESS_KEY=$(echo "$identity" | grep -o '"SecretAccessKey": "[^"]*' | awk -F'"' '{print $4}')
        export AWS_SESSION_TOKEN=$(echo "$identity" | grep -o '"SessionToken": "[^"]*' | awk -F'"' '{print $4}')
        
        # Upload qa version file to S3 bucket.
        aws s3 cp ${{ inputs.file }} ${{ inputs.destination }}/${{ inputs.app_name }}${{ inputs.version }}.apk --region ap-northeast-2


    - name: Invalidate CloudFront cache (optional)
      if: ${{ inputs.cloudfront_distribution_id != '' }}
      shell: bash
      run: |
        echo "ðŸš€ Invalidating CloudFront: ${{ inputs.cloudfront_distribution_id }}"
        aws cloudfront create-invalidation \
          --distribution-id "${{ inputs.cloudfront_distribution_id }}" \
          --paths "/*" \
          --region "${{ inputs.region }}"
